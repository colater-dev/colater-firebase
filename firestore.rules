/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. All data is nested under
 * /users/{userId}, and only the authenticated user with the matching {userId}
 * can read or write that data.  Subcollections inherit this ownership.
 *
 * Data Structure:
 * - /users/{userId}: User profile data.
 * - /users/{userId}/brands/{brandId}: Brands owned by the user.
 * - /users/{userId}/brands/{brandId}/inputVersions/{versionId}: Brand input versions.
 * - /users/{userId}/brands/{brandId}/taglineGenerations/{generationId}: AI-generated taglines.
 * - /users/{userId}/brands/{brandId}/logoGenerations/{generationId}: AI-generated logos.
 *
 * Key Security Decisions:
 * - User listing is disallowed to protect privacy.
 * - All write operations are restricted to the owner of the data.
 *
 * Denormalization for Authorization:
 *  - The 'userId' field is present in all documents nested under `/users/{userId}`. This redundancy allows simpler and faster security checks using the `isOwner()` function without needing extra `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects user profiles, allowing only the owner to read and write.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' creates a profile at /users/user123.
     * @deny (create) User with UID 'user456' attempts to create a profile at /users/user123.
     * @allow (get) User with UID 'user123' reads their profile at /users/user123.
     * @deny (get) User with UID 'user456' attempts to read the profile at /users/user123.
     * @allow (update) User with UID 'user123' updates their profile at /users/user123.
     * @deny (update) User with UID 'user456' attempts to update the profile at /users/user123.
     * @allow (delete) User with UID 'user123' deletes their profile at /users/user123.
     * @deny (delete) User with UID 'user456' attempts to delete the profile at /users/user123.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Protects brands, allowing only the owner to read and write.
     * @path /users/{userId}/brands/{brandId}
     * @allow (create) User with UID 'user123' creates a brand at /users/user123/brands/brand456.
     * @deny (create) User with UID 'user456' attempts to create a brand at /users/user123/brands/brand456.
     * @allow (get) User with UID 'user123' reads their brand at /users/user123/brands/brand456.
     * @deny (get) User with UID 'user456' attempts to read the brand at /users/user123/brands/brand456.
     * @allow (update) User with UID 'user123' updates their brand at /users/user123/brands/brand456.
     * @deny (update) User with UID 'user456' attempts to update the brand at /users/user123/brands/brand456.
     * @allow (delete) User with UID 'user123' deletes their brand at /users/user123/brands/brand456.
     * @deny (delete) User with UID 'user456' attempts to delete the brand at /users/user123/brands/brand456.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/brands/{brandId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && resource.data.userId == userId;
      allow delete: if isExistingOwner(userId);

        /**
         * @description Protects brand input versions, allowing only the owner to read and write.
         * @path /users/{userId}/brands/{brandId}/inputVersions/{versionId}
         * @allow (create) User with UID 'user123' creates a brand input version at /users/user123/brands/brand456/inputVersions/version789.
         * @deny (create) User with UID 'user456' attempts to create a brand input version at /users/user123/brands/brand456/inputVersions/version789.
         * @allow (get) User with UID 'user123' reads their brand input version at /users/user123/brands/brand456/inputVersions/version789.
         * @deny (get) User with UID 'user456' attempts to read the brand input version at /users/user123/brands/brand456/inputVersions/version789.
         * @allow (update) User with UID 'user123' updates their brand input version at /users/user123/brands/brand456/inputVersions/version789.
         * @deny (update) User with UID 'user456' attempts to update the brand input version at /users/user123/brands/brand456/inputVersions/version789.
         * @allow (delete) User with UID 'user123' deletes their brand input version at /users/user123/brands/brand456/inputVersions/version789.
         * @deny (delete) User with UID 'user456' attempts to delete the brand input version at /users/user123/brands/brand456/inputVersions/version789.
         * @principle Enforces document ownership for all operations.
         */
        match /inputVersions/{versionId} {
          allow get: if isOwner(userId);
          allow list: if isOwner(userId);
          allow create: if isOwner(userId) && request.resource.data.userId == userId;
          allow update: if isExistingOwner(userId) && resource.data.userId == userId;
          allow delete: if isExistingOwner(userId);
        }

        /**
         * @description Protects tagline generations, allowing only the owner to read and write.
         * @path /users/{userId}/brands/{brandId}/taglineGenerations/{generationId}
         * @allow (create) User with UID 'user123' creates a tagline generation at /users/user123/brands/brand456/taglineGenerations/generation789.
         * @deny (create) User with UID 'user456' attempts to create a tagline generation at /users/user123/brands/brand456/taglineGenerations/generation789.
         * @allow (get) User with UID 'user123' reads their tagline generation at /users/user123/brands/brand456/taglineGenerations/generation789.
         * @deny (get) User with UID 'user456' attempts to read the tagline generation at /users/user123/brands/brand456/taglineGenerations/generation789.
         * @allow (update) User with UID 'user123' updates their tagline generation at /users/user123/brands/brand456/taglineGenerations/generation789.
         * @deny (update) User with UID 'user456' attempts to update the tagline generation at /users/user123/brands/brand456/taglineGenerations/generation789.
         * @allow (delete) User with UID 'user123' deletes their tagline generation at /users/user123/brands/brand456/taglineGenerations/generation789.
         * @deny (delete) User with UID 'user456' attempts to delete the tagline generation at /users/user123/brands/brand456/taglineGenerations/generation789.
         * @principle Enforces document ownership for all operations.
         */
        match /taglineGenerations/{generationId} {
          allow get: if isOwner(userId);
          allow list: if isOwner(userId);
          allow create: if isOwner(userId) && request.resource.data.userId == userId;
          allow update: if isExistingOwner(userId) && resource.data.userId == userId;
          allow delete: if isExistingOwner(userId);
        }

        /**
         * @description Protects logo generations, allowing only the owner to read and write.
         * @path /users/{userId}/brands/{brandId}/logoGenerations/{generationId}
         * @allow (create) User with UID 'user123' creates a logo generation at /users/user123/brands/brand456/logoGenerations/generation789.
         * @deny (create) User with UID 'user456' attempts to create a logo generation at /users/user123/brands/brand456/logoGenerations/generation789.
         * @allow (get) User with UID 'user123' reads their logo generation at /users/user123/brands/brand456/logoGenerations/generation789.
         * @deny (get) User with UID 'user456' attempts to read the logo generation at /users/user123/brands/brand456/logoGenerations/generation789.
         * @allow (update) User with UID 'user123' updates their logo generation at /users/user123/brands/brand456/logoGenerations/generation789.
         * @deny (update) User with UID 'user456' attempts to update the logo generation at /users/user123/brands/brand456/logoGenerations/generation789.
         * @allow (delete) User with UID 'user123' deletes their logo generation at /users/user123/brands/brand456/logoGenerations/generation789.
         * @deny (delete) User with UID 'user456' attempts to delete the logo generation at /users/user123/brands/brand456/logoGenerations/generation789.
         * @principle Enforces document ownership for all operations.
         */
        match /logoGenerations/{generationId} {
          allow get: if isOwner(userId);
          allow list: if isOwner(userId);
          allow create: if isOwner(userId) && request.resource.data.userId == userId;
          allow update: if isExistingOwner(userId) && resource.data.userId == userId;
          allow delete: if isExistingOwner(userId);
        }

        /**
         * @description Protects presentations, allowing only the owner to read and write.
         * @path /users/{userId}/brands/{brandId}/presentations/{presentationId}
         */
        match /presentations/{presentationId} {
          allow get: if isOwner(userId);
          allow list: if isOwner(userId);
          allow create: if isOwner(userId) && request.resource.data.userId == userId;
          allow update: if isExistingOwner(userId) && resource.data.userId == userId;
          allow delete: if isExistingOwner(userId);
        }

        /**
         * @description Protects API keys, allowing only the owner to read and write.
         * @path /users/{userId}/brands/{brandId}/apiKeys/{keyId}
         */
        match /apiKeys/{keyId} {
          allow get: if isOwner(userId);
          allow list: if isOwner(userId);
          allow create: if isOwner(userId) && request.resource.data.userId == userId;
          allow update: if isExistingOwner(userId);
          allow delete: if isExistingOwner(userId);
        }
    }

    /**
     * @description Public brands collection for shareable brand pages.
     * @path /brands/{brandId}
     * @allow (get) Anyone can read a brand document.
     * @allow (write) Authenticated users can create/update their own brands.
     * @principle Allows public sharing of brand information.
     */
    match /brands/{brandId} {
      allow get: if true;  // Public read access
      allow list: if false; // Prevent listing all brands
      allow create, update: if isSignedIn(); // Authenticated users can write

      /**
       * @description Public logos collection for shareable logo pages.
       * @path /brands/{brandId}/logos/{logoId}
       * @allow (get) Anyone can read a logo if it's marked as public.
       * @allow (write) Authenticated users can create/update logos.
       * @principle Allows public sharing of logos.
       */
      match /logos/{logoId} {
        allow get: if true;  // Public read access for shareable logos
        allow list: if false; // Prevent listing all logos
        allow create, update: if isSignedIn(); // Authenticated users can write
        allow delete: if false; // Prevent deletion (keep in user's private collection only)
        
        /**
         * @description Feedback collection for logo ratings and comments.
         * @path /brands/{brandId}/logos/{logoId}/feedback/{feedbackId}
         * @allow (create) Anyone can submit feedback.
         * @allow (read) Anyone can read feedback.
         * @principle Allows public engagement with shared logos.
         */
        match /feedback/{feedbackId} {
          allow create: if true; // Anyone can submit feedback
          allow read: if true; // Anyone can read feedback
          allow update, delete: if false; // Prevent modification/deletion
        }
      }
    }

    /**
     * @description Lookup for public shared presentations.
     * @path /public_presentations/{token}
     */
    match /public_presentations/{token} {
      allow get: if true;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Lookup for public shared presentations (alternative name used in service).
     * @path /public_presentations_lookup/{token}
     */
    match /public_presentations_lookup/{token} {
      allow get: if true;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}